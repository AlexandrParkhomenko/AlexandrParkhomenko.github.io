---
layout: default
title: "Робототехника"
description: "Физика столкновений на примере свободного физического движка реального времени Эрвина Куманса Bullet"
date: 
---


### 5.3.2 Пересекающиеся Луч или Сегмент и Сфера

Пусть луч задается формулой $R (t)=P + t \textbf d, t ≥ 0$, где P - начало луча и нормализованный вектор направления $\textbf d$, $\textbf ||d||=1$. Если $R(t)$ описывает сегмент, а не луч, то $0 ≤ t ≤ t_{max}$. Пусть граница сферы определяется как $(X - C) · (X - C)=r^2$, где $C$ - центр сферы, а $r$ - ее радиус. Чтобы найти значение $t$, при котором луч пересекает поверхность сферы, $R (t)$ подставляется вместо $X$, давая

$$(P + t \textbf d − C) · (P + t \textbf d − C) = r^2 .$$

Пусть $\textbf m = P − C$, тогда:

- $(\textbf m + t \textbf d) · (\textbf m + t \textbf d) = r^2$ ⇔ (замена $\textbf m = P − C$)
- $(\textbf d · \textbf d)t^2 + 2(\textbf +m · \textbf d)t + (\textbf m · \textbf m) = r^2$ ⇔ (раскрытие скалярного произведения)
- $t^2 + 2(\textbf m · \textbf d)t + (\textbf m · \textbf m) − r^2 = 0$  (упрощение $\textbf d · \textbf d = 1$; каноническая форма квадратного уравнения)

Это квадратное уравнение в t. Для квадратичной формулы $t^2 + 2bt + c = 0$, решения даются $t = −b ± \sqrt {b^2 − c}$. Здесь, $b = \textbf m · \textbf d$ и $c = (\textbf m · \textbf m) − r^2$ .

**Рисунок 5.21** Различные случаи пересечения луча и сферы: (a) луч пересекает сферу (дважды) при t> 0, (b) ложное пересечение при t <0, (c) луч пересекает сферу по касательной, (d) луч начинается внутри сферы, и (e) нет пересечения.

Решение квадратного уравнения имеет три результата, классифицируемых дискриминантом $d = b^2 − c$. Если $d < 0$, нет реальных корней, что соответствует лучу, никакой частью не пересекающему сферу. Если $d = 0$, существует один действительный (двойной) корень, соответствующий лучу, касающемуся сферы в точке. Если $d > 0$, есть два действительных корня, и луч дважды пересекает сферу: один раз входит и второй раз выходит за пределы сферы. В последнем случае меньшее значение t пересечения является релевантным $t = −b − \sqrt {b^2 − c}$. Однако важно различать случай ложного пересечения луча, начинающегося вне сферы и направленного от нее, что приводит к значению пересечения $t < 0$. Этот случай проиллюстрирован на рисунке 5.21 вместе со всеми другими пересечениями луча и сферы. отношения. Следующий код реализует тест пересечения лучей и сфер.

```cpp
// Пересекает луч r = p + td, |d| = 1, со сферой s и, если они пересекаются ,
// возвращает t значение пересечения и точки пересечения q
int IntersectRaySphere(Point p, Vector d, Sphere s, float &t, Point &q){
    Vector m = p - s.c;
    float b = Dot(m, d);
    float c = Dot(m, m) - s.r * s.r;
    // Выйти, если начало r находится за пределами s (c > 0) и r направлено в противоположную сторону s (b > 0)
    if (c > 0.0f && b > 0.0f) return 0;
    float discr = b*b - c;
    // Отрицательный дискриминант соответствует отсутствия луча в сфере
    if (discr < 0.0f) return 0;
    // Теперь обнаружено, что Рэй пересекает сферу, вычисляется наименьшее значение t пересечения
    t = -b - Sqrt(discr);
    // Если t отрицательно, луч начинается внутри сферы, поэтому зафиксируйте t равным нулю
    if (t < 0.0f) t = 0.0f;
    q = p + t * d;
    return 1;
}
```

Для пересечения ориентированного отрезка AB со сферой можно использовать тот же код, задав $P = A$ и $\textbf d = (B − A) ||B − A||$. На перекрестке важно это проверить $t ≤ ||B − A||$ так, чтобы обнаруженное пересечение не выходило за пределы конца отрезка. Чтобы просто проверить, пересекает ли луч сферу (но не когда и где), код можно оптимизировать, чтобы не выполнять потенциально дорогостоящую операцию извлечения квадратного корня.

Сделав ранний выход как можно скорее, код будет выглядеть следующим образом :

```cpp
// Проверить, пересекает ли луч r = p + td сферу s
int TestRaySphere(Point p, Vector d, Sphere s){
    Vector m = p - s.c;
    float c = Dot(m, m) - s.r * s.r;
    // Если определенно существует хотя бы один реальный корень, должно быть пересечение
    if (c <= 0.0f) return 1;
    float b = Dot(m, d);
    // Ранний выход, если луч выходит за пределы сферы и луч направлен от сферы
    if (b > 0.0f) return 0;
    float disc = b*b - c;
    // Отрицательный дискриминант соответствует отсутствия луча в сфере
    if (disc < 0.0f) return 0;
    // Теперь луч должен попасть в сферу
    return 1;
}
```

Если d не нормализовано, решаемое квадратное уравнение принимает вид 
$$(\textbf d · \textbf d)t^2 + 2(\textbf m · \textbf d)t + (\textbf m · \textbf m) − r^2 = 0. $$
Для квадратного уравнения, такого как это, вида $at^2 + 2bt + c = 0$, решения даются

$$t = \frac {-b ± \sqrt {b^2 - ac}}{a} $$

с дискриминантом d = b2 − ac.

### 5.3.3 Пересекающиеся Луч или Сегмент и Параллелипипед
### 5.3.4 Пересекающиеся Линия и Треугольник
### 5.3.5 Пересекающиеся Линия и Четырехугольник
### 5.3.6 Пересекающиеся Луч или Сегмент и Треугольник
### 5.3.7 Пересекающиеся Луч или Сегмент и Цилиндр
### 5.3.8 Пересекающиеся Луч или Сегмент и Выпуклый многогранник
## 5.4 Дополнительные тесты
### 5.4.1 Тестирование Точки в многоугольнике
### 5.4.2 Тестирование Точки в Треугольнике
### 5.4.3 Тестирование Точки в Многограннике
### 5.4.4 Пересечение двух Плоскостей
### 5.4.5 Пересечение трех Плоскостей
## 5.5 Тест динамических пересечений
### 5.5.1 Уменьшение вдвое интервала пересечения движущихся объектов
### 5.5.2 Тест разделяющей оси для движущихся выпуклых объектов
### 5.5.3 Пересечение движущейся Сферы относительно Плоскости
### 5.5.4 Пересечение движущихся AABB относительно Плоскости
### 5.5.5 Пересечение движущейся Сферы относительно Сферы
### 5.5.6 Пересечение движущейся сферы относительно треугольника (и многоугольника)
